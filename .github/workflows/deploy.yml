name: deploy

on:
  push:
    branches: ["master"]

env:
  DOCKER_TAG: ghcr.io/Bober23/DiplomProject:latest

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Login to GitHub Container Registry
      run: |
        echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
    - name: Build and Push Docker image
      run: |
        docker build . --tag ${{ env.DOCKER_TAG }}
        docker push ${{ env.DOCKER_TAG }}

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install SSH keys
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
        
    - name: Transfer files to server
      run: |
        tar -czf deploy.tar.gz .
        scp deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/deploy.tar.gz
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          mkdir -p ~/deploy &&
          tar -xzf ~/deploy.tar.gz -C ~/deploy &&
          rm ~/deploy.tar.gz
        "
        
    - name: Deploy application
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/deploy &&
          docker-compose pull &&
          docker-compose up -d
        "
        
    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.ssh deploy.tar.gz
